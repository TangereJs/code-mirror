<!--
Copyright 2013 The Polymer Authors. All rights reserved.
Use of this source code is governed by a BSD-style
license that can be found in the LICENSE file.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="codemirror-import.html">

<dom-module id="code-mirror">
  <link href="codemirror-4.0/lib/codemirror.css" rel="stylesheet">
  <link href="codemirror-4.0/theme/ambiance.css" rel="stylesheet">
  <link href="codemirror-4.0/theme/ambiance-mobile.css" rel="stylesheet">
  <link href="codemirror-4.0/theme/blackboard.css" rel="stylesheet">
  <link href="codemirror-4.0/theme/cobalt.css" rel="stylesheet">
  <link href="codemirror-4.0/theme/eclipse.css" rel="stylesheet">
  <link href="codemirror-4.0/theme/elegant.css" rel="stylesheet">
  <link href="codemirror-4.0/theme/erlang-dark.css" rel="stylesheet">
  <link href="codemirror-4.0/theme/lesser-dark.css" rel="stylesheet">
  <link href="codemirror-4.0/theme/midnight.css" rel="stylesheet">
  <link href="codemirror-4.0/theme/monokai.css" rel="stylesheet">
  <link href="codemirror-4.0/theme/neat.css" rel="stylesheet">
  <link href="codemirror-4.0/theme/night.css" rel="stylesheet">
  <link href="codemirror-4.0/theme/rubyblue.css" rel="stylesheet">
  <link href="codemirror-4.0/theme/solarized.css" rel="stylesheet">
  <link href="codemirror-4.0/theme/twilight.css" rel="stylesheet">
  <link href="codemirror-4.0/theme/vibrant-ink.css" rel="stylesheet">
  <link href="codemirror-4.0/theme/xq-dark.css" rel="stylesheet">
  <link href="codemirror-4.0/theme/xq-light.css" rel="stylesheet">
  <link href="codemirror-4.0/addon/fold/foldgutter.css" rel="stylesheet">

  <template>
  </template>
</dom-module>
<script>
  Polymer({
    is: 'code-mirror',
    //      attributes="value mode theme tabSize lineNumbers",
    properties: {
      value: {
        type: String,
        value: '',
        notify: true,
        observer: 'valueChanged'
      },
      mode: {
        type: String,
        value: 'htmlmixed',
        observer: 'modeChanged'
      },
      theme: {
        type: String,
        value: 'xq-light',
        observer: 'themeChanged'
      },
      tabSize: {
        type: Number,
        value: 2,
        observer: 'tabSizeChanged'
      },
      noLineNumbers: {
        type: Boolean,
        value: false,
        observer: 'lineNumbersChanged'
      },
      name: {
        type: String,
        value: ''
      },
      disabled: {
        type: Boolean,
        value: false,
        observer: 'disabledChanged'
      }
    },
    _isReady: false,
    _scopeCssViaAttr: true,
    _mirrorInstance: {},
    ready: function () {
      if (!this.value) {
        // copy content from innerHtml/childNodes if no value was provided
        var tc = "";
        var c = Polymer.dom(this).childNodes;
        for (var i = 0; i < c.length; i++) {
          tc += c[i].textContent;
        }
        this.value = tc;
      }

      this._mirrorInstance = CodeMirror(Polymer.dom(this.root), {
        value: this.value,
        mode: this.mode,
        theme: this.theme,
        tabSize: this.tabSize,
        lineNumbers: !this.noLineNumbers,
        foldGutter: true,
        gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
      });

      var self = this;
      this._mirrorInstance.on('change', function (codeMirror, changeObj) {
        self.value = codeMirror.getValue();
      });

      this._isReady = true;
      this.valueChanged();
    },
    attached: function () {
      // *ij*
      // What is this here, you ask? Exactly! WTF is this?
      // This is a hack. A major one, at that.
      // 1) I observed that initially codeMirror does not display itself correctly when inside shadyDOM
      // 2) I also observed that when you click the codeMirror area component displays itself correctly
      // Via debugging I have found out that when you click the component as described in 2)
      // CodeMirror-scroll area captures and responds to a mousedown event
      // not only that, but which mouse button was clicked is also important
      // So, a solution is to create a mouse event, initialize it (set event's button property)
      // and dispatch it on the codemirror scroll area
      // using timeout is also important; I do not understand why exactly but its needed
      var self = this;
      setTimeout(function () {
        //        var gbcr = self._mirrorInstance.display.gutters.getBoundingClientRect();
        //        var codeMirrorScroll = Polymer.dom(self.root).querySelector('.CodeMirror-scroll');
        //        var clickEvent = document.createEvent('MouseEvent');
        //        clickEvent.initMouseEvent("mousedown", true, true, window, 0, 0, 0, gbcr.right+2, 2, false, false, false, false, 0, null);
        //        codeMirrorScroll.dispatchEvent(clickEvent);
        self._mirrorInstance.refresh();
      }, 100);
    },
    refresh: function () {
      if (this._isReady) {
        this._mirrorInstance.refresh();
      }
    },
    valueChanged: function () {
      var cursor;
      if (this._isReady) {
        cursor = this._mirrorInstance.getCursor();
        this._mirrorInstance.setValue(this.value);
        this._mirrorInstance.setCursor(cursor);
      }
    },
    modeChanged: function () {
      if (this._isReady) {
        this._mirrorInstance.setOption('mode', this.mode);
      }
    },
    themeChanged: function () {
      if (this._isReady) {
        this._mirrorInstance.setOption('theme', this.theme);
      }
    },
    tabSizeChanged: function () {
      if (this._isReady) {
        this._mirrorInstance.setOption('tabSize', this.tabSize);
      }
    },
    lineNumbersChanged: function () {
      if (this._isReady) {
        this._mirrorInstance.setOption('lineNumbers', !this.noLineNumbers);
      }
    },
    focus: function () {
      if (this._isReady) {
        this._mirrorInstance.focus();
      }
    },
    disabledChanged: function () {
      if (this._isReady) {
        this._mirrorInstance.setOption('readOnly', this.disabled);
      }
    }
  });
</script>